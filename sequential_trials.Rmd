---
title: "Sequential trials"
output: html_document
date: '2022-08-17'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rjags)
library(HDInterval)
library(dplyr)
library(patchwork)
library(stringr)
library(pbapply)
source('./R/prior.data.func.R')
source('./R/call_jags.R')
source('./R/sim.data.R')
source('./R/jags_basic_pois.R')
source('./R/jags_modified_pois.R')
source('./R/caterplot.func.R')
source('./R/prior_post_compare.R')
source('./R/run_all_models.R')

N.sim=3

```


VE from Novavax. This function takes the mean and 95% CI of vaccine effectiveness, converts to a log(RR), and estimates the precision fro the CIs, assuming it is symmetric around the mean (on scale of log(RR))
```{r}
prior.data <- prior.data.func(ve.obs.mean=39.4, ve.obs.lcl=5.3, ve.obs.ucl=61.2)
```

Set parameters for new trial population

```{r}

#Sample sizes for vaccinee group
N.vax.test <- c(300,450, 600,750, 900, 1000,1500, 2000, 2500, 3000, 3500)

#Sample sizes for control group
N.control.test <- round(N.vax.test/2)

#proportion of kids in placebo group who get the outcome
set.rate.control <- 0.024 

#VE in the new trial
set.ve.new.trial=prior.data$ve.obs.mean
```

## Scenario 1: Same VE as original trial
Novavax had 3045 vaccinees and 1581 controls; 2.4% in placebo group had primary endpoint in 90 days
```{r}
set.seed(123)

sim1 <- mapply(FUN=sim.data.func, 
       N.vax=N.vax.test, 
       N.control=N.control.test,  
       rate.control=set.rate.control, 
       ve.new.trial=set.ve.new.trial,
       n.sim=N.sim, SIMPLIFY = F)
```

## Scenario 2: no actual effect
```{r}
set.seed(456)

sim2 <- mapply(FUN=sim.data.func, 
       N.vax=N.vax.test, 
       N.control=N.control.test,  
       rate.control=set.rate.control, 
       ve.new.trial=0,
       n.sim=N.sim, SIMPLIFY = F)
```

Call all models for both simulated datasets
```{r, eval=F}
all.mods <- pbmapply(FUN=run_all_models,sim1, sim2 , SIMPLIFY=F)

saveRDS(all.mods, './Results/all.mods.rds')
```


extract 
```{r}
mod.3a <- sapply(all.mods,'[[','mod3a', simplify=F) %>%
  lapply( function(x){ 
  bind_rows(x)
    })

mod.2a <- sapply(all.mods,'[[','mod2a', simplify=F) %>%
  lapply( function(x){ 
  bind_rows(x)
    })

mod.1a <- sapply(all.mods,'[[','mod1a', simplify=F) %>%
  lapply( function(x){ 
  bind_rows(x)
    })


```

How do the three models perform when there is NO real effect?
```{r, fig.width=6, fig.height=3}
caterplot.func(all.mods, mod.version='mod1b',samp_size_selecter=1,parm.select='beta1') +
caterplot.func(all.mods, mod.version='mod2b',samp_size_selecter=1,parm.select='beta1')+
caterplot.func(all.mods, mod.version='mod3b',samp_size_selecter=1,parm.select='beta1')

```
For a larger dataset
```{r, fig.width=6, fig.height=3}
caterplot.func(all.mods, mod.version='mod1b',samp_size_selecter=10,parm.select='beta1') +
caterplot.func(all.mods, mod.version='mod2b',samp_size_selecter=10,parm.select='beta1')+
caterplot.func(all.mods, mod.version='mod3b',samp_size_selecter=10,parm.select='beta1')

```

How do the three models perform when there is a real effect?
```{r, fig.width=6, fig.height=3}
caterplot.func(all.mods, mod.version='mod1a',samp_size_selecter=1,parm.select='beta1') +
caterplot.func(all.mods, mod.version='mod2a',samp_size_selecter=1,parm.select='beta1')+
caterplot.func(all.mods, mod.version='mod3a',samp_size_selecter=1,parm.select='beta1')
```

## Alpha 
```{r, fig.width=3, fig.height=3}
caterplot.func(all.mods, mod.version='mod3a',samp_size_selecter=1,parm.select='alpha') +
  caterplot.func(all.mods, mod.version='mod3a',samp_size_selecter=11,parm.select='alpha') 
```

## Prior vs posterior
```{r}
density_compare_mod1a <- lapply(mod1a, function(y) prior_post_compare(y))

density_compare_mod1b <- lapply(mod1a, function(y) prior_post_compare(y))

density_compare_mod2a <- lapply(mod2a, function(y) prior_post_compare(y))

density_compare_mod2b <- lapply(mod2b, function(y) prior_post_compare(y))

density_compare_mod3a <- lapply(mod3a, function(y) prior_post_compare(y))

density_compare_mod3b <- lapply(mod3b, function(y) prior_post_compare(y))

density_compare_mod2a[[1]]

density_compare_mod3a[[1]]

density_compare_mod2b[[1]]

density_compare_mod3b[[1]]

```

## Across a range of sample sizes:
Power and type 1 error for the 3 models
```{r}
samp_size <- c(300,600,1000,1500,2000,3000)

powerA= c(0.06,0.12,0.24,0.33,0.45, 0.60)
powerB= c(0.87,0.83,0.87, 0.91, 0.90, 0.92)
powerC= c(0.07,0.31,0.48,0.63, 0.68, 0.78)

type1_A = c(0.02,0.01,0.02, 0.03,0.03, 0.03)
type1_B = c(0.64, 0.49, 0.39, 0.29,0.25, 0.25)
type1_C = c(0.04, 0.06, 0.05, 0.13,0.12, 0.12)

plot(samp_size, powerC)


  
  
```



