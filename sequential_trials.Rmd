---
title: "Sequential trials"
output: html_document
date: '2022-08-17'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rjags)
library(HDInterval)
library(dplyr)
library(patchwork)
library(stringr)
library(pbapply)
library(ggplot2)
source('./R/prior.data.func.R')
source('./R/call_jags.R')
source('./R/sim.data.R')
source('./R/jags_basic_pois.R')
source('./R/jags_modified_pois_commensurate_gamma.R') #NOTE, this is experimental version
source('./R/jags_modified_pois_commensurate_hcauchy.R') #NOTE, this is experimental version
source('./R/jags_modified_pois_commensurate_uniform.R') #NOTE, this is experimental version

source('./R/caterplot.func.R')
source('./R/prior_post_compare.R')
source('./R/extract_parm.R')

source('./R/run_all_models.R')

N.sim=100

```


```{r}
hist(rgamma(1000,1,0.001))

#SD
sd <- 1/sqrt(rgamma(10000,1,0.1))

mean(1/sqrt(rgamma(10000,1,0.1)))
median(1/sqrt(rgamma(10000,1,0.1)))

hist(1/sqrt(rgamma(10000,0.01,0.01)), main='SD')

rnorm(1000,0, 0.5)

# 
        sigma <- abs(rlst(n=10000,df=1, sigma=1/sqrt(50), mu=0) )
  	    prec <- 1/(sigma^2)
# # 	    
# # 	    mean(prec)
# library(extraDistr)
# prec2 <- rhcauchy(10000,sigma=0.2)
```


VE from Novavax. This function takes the mean and 95% CI of vaccine effectiveness, converts to a log(RR), and estimates the precision from the CIs, assuming it is symmetric around the mean (on scale of log(RR))
```{r}
#NOTE! These do not do anything: ve.obs.mean=1e-4, log_irr.obs=0
prior.data <- prior.data.func( N_cases_orig =c(6,8), ve.obs.mean=0,ve.obs.lcl=0, ve.obs.ucl=0, pop_orig= c(26, 23))

#Try larger initial sample
#prior.data <- prior.data.func(ve.obs.mean=39.4, ve.obs.lcl=5.3, ve.obs.ucl=61.2, N_cases_orig =c(350,410), pop_orig= c(1430, 2765))

```

Set parameters for new trial population

```{r}

#Sample sizes for vaccinee group
N.vax.test <- c(249)

#Sample sizes for control group
N.control.test <- c(240)

#proportion of kids in placebo group who get the outcome set to 0.024 for Noavavx
set.rate.control <- 0.23 #


#VE in the new trial
set.ve.new.trial= -51 #(IRR=1.51)
```

## Scenario 1: Same VE as original trial

```{r}
set.seed(123)

sim1 <- mapply(FUN=sim.data.func, 
       N.vax=N.vax.test, 
       N.control=N.control.test,  
       rate.control=set.rate.control, 
       ve.new.trial=set.ve.new.trial,
       n.sim=N.sim, SIMPLIFY = F)
```

## Scenario 2: no actual effect
```{r}
set.seed(456)

sim2 <- mapply(FUN=sim.data.func, 
       N.vax=N.vax.test, 
       N.control=N.control.test,  
       rate.control=set.rate.control, 
       ve.new.trial=0,
       n.sim=N.sim, SIMPLIFY = F)
```

Call all models for both simulated datasets
```{r, eval=F}
all.mods <- pbmapply(FUN=run_all_models,sim1, sim2 , SIMPLIFY=F)

saveRDS(all.mods, './Results/all.mods.rds')
```

```{r}
all.mods <- readRDS( './Results/all.mods.rds')

```

extract 
```{r}
mod.4a <- sapply(all.mods,'[[','mod4a', simplify=F) %>%
  lapply( function(x){ 
  bind_rows(x)
    })
mod.3a <- sapply(all.mods,'[[','mod3a', simplify=F) %>%
  lapply( function(x){ 
  bind_rows(x)
    })

mod.2a <- sapply(all.mods,'[[','mod2a', simplify=F) %>%
  lapply( function(x){ 
  bind_rows(x)
    })

mod.1a <- sapply(all.mods,'[[','mod1a', simplify=F) %>%
  lapply( function(x){ 
  bind_rows(x)
    })


```

How do the three models perform when there is NO real effect?

3:Gamma, 4:Half-Cauchy

```{r, fig.width=6, fig.height=3}
caterplot.func(all.mods, mod.version='mod1b',samp_size_selecter=1,parm.select='beta1') +
caterplot.func(all.mods, mod.version='mod3b',samp_size_selecter=1,parm.select='beta1')+
caterplot.func(all.mods, mod.version='mod4b',samp_size_selecter=1,parm.select='beta1')

```

How do the three models perform when there is a real effect?

```{r, fig.width=6, fig.height=3}
caterplot.func(all.mods, mod.version='mod1a',samp_size_selecter=1,parm.select='beta1') +
caterplot.func(all.mods, mod.version='mod3a',samp_size_selecter=1,parm.select='beta1')+
  caterplot.func(all.mods, mod.version='mod4a',samp_size_selecter=1,parm.select='beta1')

```
