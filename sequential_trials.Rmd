---
title: "Sequential trials"
output: html_document
date: '2022-08-17'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rjags)
library(HDInterval)
library(dplyr)
library(stringr)
library(pbapply)
source('./R/prior.data.func.R')
source('./R/call_jags.R')
source('./R/sim.data.R')
source('./R/jags_basic_logit.R')
source('./R/caterplot.func.R')
source('./R/prior_post_compare.R')

```


VE from Novavax. This function takes the mean and 95% CI of vaccine effectiveness, converts to a log(RR), and estimates the precision fro the CIs, assuming it is symmetric around the mean (on scale of log(RR))
```{r}
prior.data <- prior.data.func(ve.obs.mean=39.4, ve.obs.lcl=5.3, ve.obs.ucl=61.2)
```


## Scenario 1: Same VE as original trial
Novvax had 3045 vaccinees and 1581 controls; 2.4% in placebo group had primary endpoint in 90 days
```{r}
set.seed(123)
N.sim=10

sim1 <- sim.data.func(N.vax = 3045,
                     N.control = 1581,
                     rate.control = 0.024,
                     ve.new.trial=prior.data$ve.obs.mean,
                     n.sim=N.sim)
```

Scenario 2: no actual effect
```{r}
set.seed(123)
N.sim=10

sim2 <- sim.data.func(N.vax = 3045,
                     N.control = 1581,
                     rate.control = 0.024,
                     ve.new.trial=0,
                     n.sim=N.sim)
```

Logistic regression model with uninformative prior

test when there is or is not an effect in the follow up study
```{r}
 mod1a <- pblapply(1:N.sim, function(x) call_jags(sim.ds=sim1, prior.mean=0, prior.prec=1e-4,repN=x))

 mod1b <- pblapply(1:N.sim, function(x) call_jags(sim.ds=sim2, prior.mean=0, prior.prec=1e-4,repN=x))
```

Informative prior, with mean and precision from Novavax
```{r}
 mod2a <- pblapply(1:N.sim, function(x) call_jags(sim.ds=sim1,prior.mean=prior.data$log_irr.obs[1], prior.prec=prior.data$prec.log.irr.obs,repN=x))

 mod2b <- pblapply(1:N.sim, function(x) call_jags(sim.ds=sim2,prior.mean=prior.data$log_irr.obs[1], prior.prec=prior.data$prec.log.irr.obs,repN=x))
```
Informative prior, but with Alpha to downweight variance if needed
```{r}
 mod3a <- pblapply(1:N.sim, function(x) call_jags(sim.ds=sim1,prior.mean=prior.data$log_irr.obs[1], prior.prec=prior.data$prec.log.irr.obs,repN=x, model.select=model_string_modified_logit) )

 mod3b <- pblapply(1:N.sim, function(x) call_jags(sim.ds=sim2,prior.mean=prior.data$log_irr.obs[1], prior.prec=prior.data$prec.log.irr.obs,repN=x, model.select=model_string_modified_logit) )

```



How do the three models perform when there is NO real effect?
```{r}
caterplot.func(mod1b)
caterplot.func(mod2b)
caterplot.func(mod3b)

```

How do the three models perform when there is a real effect?
```{r}
caterplot.func(mod1a)
caterplot.func(mod2a)
caterplot.func(mod3a)

```


## Prior vs posterior
```{r}
density_compare_mod1a <- lapply(mod1a, function(y) prior_post_compare(y))

density_compare_mod1b <- lapply(mod1a, function(y) prior_post_compare(y))

density_compare_mod2a <- lapply(mod2a, function(y) prior_post_compare(y))

density_compare_mod2b <- lapply(mod2b, function(y) prior_post_compare(y))

density_compare_mod3a <- lapply(mod3a, function(y) prior_post_compare(y))

density_compare_mod3b <- lapply(mod3b, function(y) prior_post_compare(y))

density_compare_mod2a[[1]]

density_compare_mod3a[[1]]

density_compare_mod2b[[1]]

density_compare_mod3b[[1]]

```


