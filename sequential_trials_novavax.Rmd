---
title: "Sequential trials"
output: html_document
date: '2022-12-08'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(rjags)
library(HDInterval)
library(dplyr, warn.conflicts = FALSE)
options(dplyr.summarise.inform = FALSE)

library(patchwork)
library(stringr)
library(pbapply)
library(parallel)
library(plotly)

library(ggplot2)
library(extraDistr)
source('./R/prior.data.func.R')
source('./R/call_jags.R')
source('./R/sim.data.R')
source('./R/jags_basic_pois.R')
source('./R/jags_modified_pois_commensurate_gamma.R') #NOTE, this is experimental version
source('./R/jags_modified_pois_commensurate_uniform.R') #NOTE, this is experimental version
source('./R/jags_modified_pois_commensurate_half_cauchy.R') #NOTE, this is experimental version

source('./R/caterplot.func.R')
source('./R/prior_post_compare.R')
source('./R/extract_parm.R')

source('./R/run_all_models.R')

N.sim=500


```

Prior for VE proposed <https://hbiostat.org/proj/covid19/bayesplan.html#operating-characteristics> (low probability of extreme effects, symmetric around 0) A skeptical prior as defined by Frank harrell has low probability of extremes (e.g., 5% prior probability that the effect is \>95% or 5% that it is the inverse )

```{r}

# p(RR<0.05) = P(RR>1/0.05) 

#IRR=0.05 = 95%VE 
#log(0.05) log(IRR)

#IRR=1.95   #-95%VE




hist(rnorm(10000, mean=0, sd=1.821))

mean(rnorm(10000, mean=0, sd=1.821) <log(0.05) ) #~5% of people have a VE of >95%
mean(rnorm(10000, mean=0, sd=1.821) >log(1/0.05) ) # ~5% of people have a VE of >-95%


prior.sd.logrr <- (abs(log(1-44.4/100)  -  log(1-19.6/100)))/1.96
prior.mean.logrr <- log(1-44.4/100)

hist(rnorm(10000, mean=prior.mean.logrr, sd=prior.sd.logrr))  #informative prior

```

For commensurate prior, need to set hyperior for variance as well. If we were to use the historical data fuklly, we would want the hyperprior for posterior variance for commensurate to approach 0. If it doesn't use it at all, we would want variance to be sufficiently large to cover negative and neutral effects

```{r}
 hist(rgamma(1000,0.01, 0.01)) # gamma hyperprior from psborrow
 mean(rgamma(1000,0.01, 0.01)) # gamma hyperprior from psborrow

  hist(rgamma(1000,0.1, 0.1)) # gamma hyperprior from psborrow
 mean(rgamma(1000,0.1, 0.1)) # gamma hyperprior from psborrow

 
   hist(rgamma(1000,1, 1)) # gamma hyperprior from psborrow
   
 mean(rgamma(1000,1, 1)) # gamma hyperprior from psborrow

    hist(rgamma(1000,10, 10)) # gamma hyperprior from psborrow
 mean(rgamma(1000,10, 10)) # gamma hyperprior from psborrow



 mean(rgamma(1000,10, 10)) # gamma hyperprior from psborrow
 var(rgamma(1000,10, 10)) # gamma hyperprior from psborrow

hist(rnorm(10000,0, rgamma(1000,1.821, 1)) )



hist(rnorm(10000,-1.2, rgamma(10000,1, 3)) )
 


#If there is no information in the new trial, then we would want it to revert to something like the skeptical prior from the original trial N(0,sd=1.821) in terms of coverage of extremes P(VE>95%)

#if prior mean= -0.5, want to have a variance that is large enough to cover null with decent probability, maybe something like a SD=2

hist(rnorm(10000, -1.2 ,2))
mean(rnorm(10000, -1.2, 2.0)< log(0.05) )
mean(rnorm(10000, -1.2, 2.0)> log(1/0.05) )

#how does this combine with a prior mean?
hist(rnorm(10000,-1.2, rgamma(10000,1, 1)) )


hist(rnorm(10000,-1.2, rgamma(10000,5, 2)) )

hist(rnorm(10000, mean=prior.mean.logrr, sd=1.8)) #infrmative mean

```

VE from Novavax. This function takes the mean and 95% CI of vaccine effectiveness, converts to a log(RR), and estimates the precision fro the CIs, assuming it is symmetric around the mean (on scale of log(RR))

```{r}
#This is main novavax result
#prior.data <- prior.data.func(ve.obs.mean=39.4, ve.obs.lcl=5.3, ve.obs.ucl=61.2, N_cases_orig =c(35,41), pop_orig= c(1430, 2765))

#Table 2: per protocol 90 day VE against RSV LRTI with hospitalization
prior.data <- prior.data.func(ve.obs.mean=44.4, ve.obs.lcl=19.6, ve.obs.ucl=61.5, N_cases_orig =c(53,57), pop_orig= c(1430, 2765))
```

Set parameters for new trial population

```{r}


#proportion of kids in placebo group who get the outcome set to 0.037 for Noavavx secondary endpoint
set.rate.control <- 0.037 

#VE in the new trial, if it agrees with original
set.ve.new.trial.agree = prior.data$ve.obs.mean

#discrepant VE in new trial (higher)
set.ve.new.trial.higher = 90

```

## Scenario 1: Same VE as original trial

Novavax had 3045 vaccinees and 1581 controls; 2.4% in placebo group had primary endpoint in 90 days

```{r}
set.seed(123)

sim1 <- sim.data.func(N.vax = 10000,
                     N.control = 10000,
                     rate.control = set.rate.control,
                     ve.new.trial=set.ve.new.trial.agree,
                     n.sim=N.sim)
  
```

## Scenario 2: no actual effect

```{r}
set.seed(456)

sim2 <- sim.data.func(N.vax = 10000,
                     N.control = 10000,
                     rate.control = set.rate.control,
                     ve.new.trial=0,
                     n.sim=N.sim)
```

## Scenario 3: discrepant actual effect

```{r}
set.seed(456)

sim3 <- sim.data.func(N.vax = 10000,
                     N.control = 10000,
                     rate.control = set.rate.control,
                     ve.new.trial=set.ve.new.trial.higher,
                     n.sim=N.sim)
```

## At which points do we want to evaluate VE?

How many vaccinees are enrolled?

```{r}

eval_points = seq(from=100, to=2000, by=100)

```

test run. 500 vaccinees+500 controls. It takes 0.27 seconds for 1 run. Need to test 20 cut points, 3 true VE levels, and 500 sims (30,000 combos). This would take 135 minutes if run sequentially.

generate combined dataset for modeling--need to fill 0s if stratum not represented

```{r}
mod.ds1 <- lapply(eval_points , function(set.pop){
    ds1 <- bind_rows(sim1, sim2, sim3) %>%
        group_by(repN,ve.new.trial, treatment) %>%
      mutate(pop=set.pop) %>%
      filter( ((ID<pop &treatment=='placebo')|(ID<pop &treatment=='vax') )) %>%
          summarize(N_cases= n(), pop=mean(pop)) %>%
      ungroup() 
    
return(ds1)
    }) %>%
  bind_rows() %>%
  tidyr::complete(repN,ve.new.trial, treatment , pop,   fill=list(N_cases=0)) %>%
    mutate( vax=if_else(treatment=='vax',1,0)) 

```

Accrual of cases in the 500 trials

```{r}
mod.ds1 %>%
  filter(ve.new.trial==44.4) %>%
  ggplot(aes(x=pop, y=N_cases, group=interaction(repN, treatment), color=treatment))+
  geom_line(alpha=0.1) +
  theme_classic()
```

Prior selection based on: <https://hbiostat.org/proj/covid19/bayesplan.html>

```{r}
ptm <- proc.time()

mod1 <- mod.ds1 %>%
  filter( repN==3  & pop==1000 &  ve.new.trial==0 ) %>%
  call_jags( prior.mean=0, prior.prec=1/1.821^2) %>%
  filter(parm=='beta1')

proc.time() - ptm


mod2 <- mod.ds1 %>%
  filter( repN==3  & pop==1000 &  ve.new.trial==0 ) %>%
  call_jags( prior.mean=0, prior.prec=1/1.821^2, model.select=model_string_commensurate_gamma) %>%
  filter(parm=='beta1')

mod3 <- mod.ds1 %>%
  filter( repN==3  & pop==1000 &  ve.new.trial==0 ) %>%
  call_jags( prior.sd.upper=100, model.select=model_string_commensurate_uniform) %>%
  filter(parm=='beta1')


mod4 <- mod.ds1 %>%
  filter( repN==3  & pop==1000 &  ve.new.trial==0 ) %>%
  call_jags( prior.mean=prior.data$log_irr.obs[1], prior.prec=1/1.821^2, model.select=model_string_commensurate_half_cauchy) %>%
  filter(parm=='beta1')



bind_rows(mod1, mod2, mod3, mod4)
```

Check dataset--shows all strata have 2 obs

```{r}

mod.ds1 %>%
  group_by(repN, ve.new.trial, pop) %>%
  summarize(n_obs=n()) %>%
  ungroup() %>%
  summarize(n_obs_range =range(n_obs))
```

Call all models for both simulated datasets. Use parallel processing; takes \~60 min to run on 7 cores

```{r, eval=F}
ptm <- proc.time()


library(multidplyr)
ptm <- proc.time()
numCores = detectCores() -1
cluster1 <- new_cluster(numCores)
cluster_library(cluster1, "dplyr")
cluster_library(cluster1, "rjags")
cluster_library(cluster1, "HDInterval")
cluster_copy(cluster1, "call_jags")
cluster_copy(cluster1, "prior.data")
cluster_copy(cluster1, "model_string_basic_pois")
cluster_copy(cluster1, "model_string_commensurate_gamma")
cluster_copy(cluster1, "model_string_commensurate_uniform")
cluster_copy(cluster1, "model_string_commensurate_half_cauchy")


#baseline model without pooling, uninformative prior

mod0 <- mod.ds1 %>%
  group_by(repN,pop,ve.new.trial) %>%
  multidplyr::partition(cluster=cluster1)  %>%
 do(call_jags(., prior.mean=0,  prior.prec=1e-4 )) %>%
  collect() %>%
  ungroup() %>%
  mutate(Pooling_type='none', prior.info= 'N(0,1e-4)' ) 

#baseline model without pooling
mod1 <- mod.ds1 %>%
  group_by(repN,pop,ve.new.trial) %>%
  multidplyr::partition(cluster=cluster1)  %>%
 do(call_jags(. , model.select=model_string_basic_pois, prior.mean=0,  prior.prec=1/1.821^2 ) ) %>%
  collect() %>%
  ungroup() %>%
  mutate(Pooling_type='none', prior.info= 'N(0,1.821^2)')

proc.time() - ptm

ptm <- proc.time()
#Commensurate prior pooling
mod3 <- mod.ds1 %>%
  group_by(repN,pop,ve.new.trial) %>%
  multidplyr::partition(cluster=cluster1)  %>%
 do(call_jags(., prior.mean=prior.data$log_irr.obs[1], prior.prec=1/1.821^2, model.select=model_string_commensurate_gamma, set_tau_shp=3, set_tau_rate=2)) %>%
  collect() %>%
  ungroup() %>%
  mutate(Pooling_type='Commensurate', prior.info= 'N(u1,tau); IG(3,2)')

proc.time() - ptm

#Commensurate prior pooling
mod4 <- mod.ds1 %>%
  group_by(repN,pop,ve.new.trial) %>%
  multidplyr::partition(cluster=cluster1)  %>%
 do(call_jags(., prior.mean=prior.data$log_irr.obs[1], prior.prec=1/1.821^2, model.select=model_string_commensurate_gamma, set_tau_shp=1, set_tau_rate=1)) %>%
  collect() %>%
  ungroup() %>%
  mutate(Pooling_type='Commensurate', prior.info= 'N(u1,tau); IG(1,1)')

#Commensurate prior pooling
mod4 <- mod.ds1 %>%
  group_by(repN,pop,ve.new.trial) %>%
  multidplyr::partition(cluster=cluster1)  %>%
 do(call_jags(., prior.mean=prior.data$log_irr.obs[1], prior.prec=1/1.821^2, model.select=model_string_commensurate_gamma, set_tau_shp=0.01, set_tau_rate=0.01)) %>%
  collect() %>%
  ungroup() %>%
  mutate(Pooling_type='Commensurate', prior.info= 'N(u1,tau); IG(0.01,0.01)')

mod5 <- mod.ds1 %>%
  group_by(repN,pop,ve.new.trial) %>%
  multidplyr::partition(cluster=cluster1)  %>%
 do(call_jags(., prior.mean=prior.data$log_irr.obs[1], prior.prec=1/1.821^2, model.select=model_string_commensurate_uniform, prior.sd.upper=2)) %>%
  collect() %>%
  ungroup() %>%
  mutate(Pooling_type='Commensurate', prior.info= 'N(u1,tau); U(0,2)')

mod6 <- mod.ds1 %>%
  group_by(repN,pop,ve.new.trial) %>%
  multidplyr::partition(cluster=cluster1)  %>%
 do(call_jags(., prior.mean=prior.data$log_irr.obs[1], prior.prec=1/1.821^2, model.select=model_string_commensurate_uniform, prior.sd.upper=100)) %>%
  collect() %>%
  ungroup() %>%
  mutate(Pooling_type='Commensurate', prior.info= 'N(u1,tau); U(0,100)')

mod7 <- mod.ds1 %>%
  group_by(repN,pop,ve.new.trial) %>%
  multidplyr::partition(cluster=cluster1)  %>%
 do(call_jags(. , prior.mean=prior.data$log_irr.obs[1], prior.prec=1/1.821^2, model.select=model_string_commensurate_half_cauchy)) %>%
  collect() %>%
  ungroup() %>%
  mutate(Pooling_type='Commensurate', prior.info= 'N(u1,tau);t(0,1,1)T(0,)')


proc.time() - ptm

all.mods <- bind_rows(mod0,mod1, mod3, mod4, mod5, mod6, mod7)

saveRDS(all.mods, './Results/all.mods_novavax.rds')

ptm <- proc.time()

```

```{r}
all.mods <- readRDS( './Results/all.mods_novavax.rds') %>%
  rename(parm_mean=mean) %>%
  mutate(  parm_mean = if_else( parm_mean< (-4), (-4), 
                  if_else(parm_mean> 4,4, parm_mean)),
          lcl = if_else(lcl< (-4), (-4), 
                  if_else(lcl>4,4, lcl)),
           ucl = if_else(ucl< (-4), (-4), 
                  if_else(ucl>4,4, ucl))
         
  )

```

## Bayesian estimates of performance

```{r}

#the p_xx are replicated for each parameter so filter to just 1 parameter
probs <- all.mods %>% 
  group_by(repN, pop, ve.new.trial,Pooling_type,prior.info) %>%
  filter(parm=='beta1')  %>%
  ungroup()
```

### Trajectories for 500 trials

This shows how the probabilities evolve as more data accrue. This shows probability of any benefit: P(VE\>0\|data)

```{r}
probs %>%
  filter(ve.new.trial==44.4 & Pooling_type != 'Full' & repN %in% c(1:10)) %>%
  mutate(prior.info = as.factor(prior.info)) %>%
  
ggplot( aes(x=pop, y=p_0, group=interaction(repN,prior.info), color=Pooling_type)) +
  geom_line( alpha=0.1) +
  theme_classic() +
  facet_wrap(~prior.info)
```

## Stopping criteria

If doing this as a trial with fixed sample size, can just use the plots above as a guid; if performing as a sequential trial, need to look at cumulative probability of having hit the stopping criteria by a certain point. P(benefit\>0.95\|data)

for each trial, call 0/1 based on if we have hit 0.95 at this sample size or earlier

```{r, fig.width=6, fig.height=3}
stopped_efficacy1 =probs %>%
  arrange(repN, ve.new.trial,prior.info ,pop) %>%
 group_by(repN,  ve.new.trial,prior.info) %>%
  mutate( eff = 1*(p_0>0.975),
            stop = cumsum(eff) ,
          stop = if_else(stop>=1,1,0)) %>%
  ungroup() %>%
  group_by(pop, ve.new.trial,prior.info) %>%
    summarize(prop_stopped = mean(stop))        


stopped_efficacy1 %>%
ggplot(aes( x=pop, y=prop_stopped, group=prior.info, color=prior.info)) +
  geom_line() +
  facet_wrap(~ ve.new.trial) +
  theme_classic() +
  geom_hline(yintercept = c(0.05, 0.95), lty=2, col='gray')+
  ggtitle('Cumulative proportion with >97.5% prob that effect is >0%VE')

stopped_efficacy1 =probs %>%
  arrange(repN, ve.new.trial,prior.info ,pop) %>%
 group_by(repN,  ve.new.trial,prior.info) %>%
  mutate( eff = 1*(p_0_90>0.975),
            stop = cumsum(eff) ,
          stop = if_else(stop>=1,1,0)) %>%
  ungroup() %>%
  group_by(pop, ve.new.trial,prior.info) %>%
    summarize(prop_stopped = mean(stop))        


stopped_efficacy1 %>%
ggplot(aes( x=pop, y=prop_stopped, group=prior.info, color=prior.info)) +
  geom_line() +
  facet_wrap(~ ve.new.trial) +
  theme_classic() +
  geom_hline(yintercept = c(0.05, 0.95), lty=2, col='gray') +
  ggtitle('Cumulative proportion with >97.5% prob that effect is >10%VE')


stopped_efficacy2 =probs %>%
  arrange(repN, ve.new.trial,prior.info ,pop) %>%
 group_by(repN,  ve.new.trial,prior.info) %>%
  mutate( eff = 1*(p_0_75>0.975),
            stop = cumsum(eff) ,
          stop = if_else(stop>=1,1,0)) %>%
  ungroup() %>%
  group_by(pop, ve.new.trial,prior.info) %>%
    summarize(prop_stopped = mean(stop))        


stopped_efficacy2 %>%
ggplot(aes( x=pop, y=prop_stopped, group=prior.info, color=prior.info)) +
  geom_line() +
  facet_wrap(~ ve.new.trial) +
  theme_classic() +
  geom_hline(yintercept = c(0.05, 0.95), lty=2, col='gray')+
  ggtitle('Cumulative proportion with >97.5% prob that effect is >25%VE')


stopped_efficacy3 =probs %>%
  arrange(repN, ve.new.trial,prior.info ,pop) %>%
 group_by(repN,  ve.new.trial,prior.info) %>%
  mutate( eff = 1*(p_0>0.999),
            stop = cumsum(eff) ,
          stop = if_else(stop>=1,1,0)) %>%
  ungroup() %>%
  group_by(pop, ve.new.trial,prior.info) %>%
    summarize(prop_stopped = mean(stop))        


stopped_efficacy3 %>%
ggplot(aes( x=pop, y=prop_stopped, group=prior.info, color=prior.info)) +
  geom_line() +
  facet_wrap(~ ve.new.trial) +
  theme_classic() +
  geom_hline(yintercept = c(0.05, 0.95), lty=2, col='gray')+
  ggtitle('Cumulative proportion with >99.9% prob that effect is >0%VE')

stopped_efficacy3 =probs %>%
  arrange(repN, ve.new.trial,prior.info ,pop) %>%
 group_by(repN,  ve.new.trial,prior.info) %>%
  mutate( eff = 1*(p_0>0.99),
            stop = cumsum(eff) ,
          stop = if_else(stop>=1,1,0)) %>%
  ungroup() %>%
  group_by(pop, ve.new.trial,prior.info) %>%
    summarize(prop_stopped = mean(stop))        


stopped_efficacy3 %>%
ggplot(aes( x=pop, y=prop_stopped, group=prior.info, color=prior.info)) +
  geom_line() +
  facet_wrap(~ ve.new.trial) +
  theme_classic() +
  geom_hline(yintercept = c(0.05, 0.95), lty=2, col='gray')+
  ggtitle('Cumulative proportion with >99% prob that effect is >0%VE')
```

Futility

```{r}
stopped_futility =probs %>%
  arrange(repN, ve.new.trial,prior.info ,pop) %>%
 group_by(repN, pop, ve.new.trial,prior.info) %>%
  mutate( fut = 1*((1-p_0)>0.5),
            stop = cumsum(fut) ,
          stop = if_else(stop>=1,1,0)) %>%
  ungroup() %>%
  group_by(pop, ve.new.trial,prior.info) %>%
    summarize(prop_stopped = mean(stop))        


ggplot(stopped_futility, aes( x=pop, y=prop_stopped, group=prior.info, color=prior.info)) +
  geom_line() +
  facet_wrap(~ ve.new.trial) +
  theme_classic() +
  geom_hline(yintercept = c(0.05, 0.95))
```

### Summaries of the trajectories

What is the probability of detecting any effect if there is (A) No effect (B) a moderate effect in line with the original trial or (C) A large effect, bigger than original trial? The shaded region shows where 90% of the estimates lie

```{r, fig.width=7, fig.height=7}
probs %>%
  filter(Pooling_type != 'Full') %>%
  mutate(Pooling_type = as.factor(Pooling_type), ve.new.trial=as.factor(ve.new.trial)) %>%
  group_by(pop, ve.new.trial,Pooling_type, prior.info) %>%
  summarize(p_0_mean=mean(p_0), p_0_lcl=quantile(p_0, probs=0.05),
             p_0_ucl=quantile(p_0, probs=0.95)) %>%
ggplot( aes(x=pop, y=p_0_mean,  color=interaction(Pooling_type,prior.info), group=interaction(Pooling_type,prior.info), fill=Pooling_type)) +
  geom_line() +
  geom_ribbon( aes(x=pop, ymin=p_0_lcl, 
                   ymax=p_0_ucl,
                   color=interaction(Pooling_type,prior.info), group=interaction(Pooling_type,prior.info)), alpha=0.1) +
  theme_classic() +
  facet_grid(prior.info~ve.new.trial)+
  ggtitle('Prob any effect (mean and central 90% from 500 simulated trials)')
```

What is the probability of detecting small or no effect (or effect between 20% decline or 25% increase) when the data truly have: (A) No effect (B) a moderate effect in line with the original trial or (C) A large effect, bigger than original trial? the shaded region shows where 90% of the estimates lie

```{r, fig.width=7, fig.height=7}
probs %>%
  filter(Pooling_type != 'Full') %>%
  mutate(Pooling_type = as.factor(Pooling_type), ve.new.trial=as.factor(ve.new.trial)) %>%
  group_by(pop, ve.new.trial,Pooling_type,prior.info) %>%
  summarize(p_mean=mean(p_similar_0_8__1_25), p_lcl=quantile(p_similar_0_8__1_25, probs=0.05),
             p_ucl=quantile(p_similar_0_8__1_25, probs=0.95)) %>%
ggplot( aes(x=pop, y=p_mean,  color=Pooling_type, group=interaction(Pooling_type, prior.info), fill=Pooling_type)) +
  geom_line() +
  geom_ribbon( aes(x=pop, ymin=p_lcl, 
                   ymax=p_ucl,
                   color=Pooling_type, group=interaction(Pooling_type,prior.info)), alpha=0.1) +
  theme_classic() +
  facet_grid(prior.info~ve.new.trial)+
  ggtitle('Prob effect is small or null')
```

What is the probability of detecting a moderate effect or greater (at least 25% decline) effect when the data truly have: (A) No effect (B) a moderate effect in line with the original trial or (C) A large effect, bigger than original trial? the shaded region shows where 90% of the estimates lie

```{r, fig.width=7, fig.height=7}
probs %>%
  filter(Pooling_type != 'Full') %>%
  mutate(Pooling_type = as.factor(Pooling_type), ve.new.trial=as.factor(ve.new.trial)) %>%
  group_by(pop, ve.new.trial,Pooling_type,prior.info) %>%
  summarize(p_mean=mean(p_0_75), p_lcl=quantile(p_0_75, probs=0.05),
             p_ucl=quantile(p_0_75, probs=0.95)) %>%
ggplot( aes(x=pop, y=p_mean,  color=Pooling_type, group=interaction(Pooling_type,prior.info), fill=Pooling_type)) +
  geom_line() +
  geom_ribbon( aes(x=pop, ymin=p_lcl, 
                   ymax=p_ucl,
                   color=Pooling_type, group=interaction(Pooling_type,prior.info)), alpha=0.1) +
  theme_classic() +
  facet_grid(prior.info~ve.new.trial)+
  ggtitle('Prob Moderate effect')
```

What is the probability of detecting a harmful effect or greater (an increase in disease rates) when the data truly have: (A) No effect (B) a moderate effect in line with the original trial or (C) A large effect, bigger than original trial? the shaded region shows where 90% of the estimates lie

```{r}
probs %>%
  filter(Pooling_type != 'Full') %>%
  mutate(Pooling_type = as.factor(Pooling_type), ve.new.trial=as.factor(ve.new.trial)) %>%
  group_by(pop, ve.new.trial,Pooling_type,prior.info) %>%
  summarize(p_mean=mean(p_harm_o1), p_lcl=quantile(p_harm_o1, probs=0.05),
             p_ucl=quantile(p_harm_o1, probs=0.95)) %>%
ggplot( aes(x=pop, y=p_mean,  color=Pooling_type, group=interaction(Pooling_type,prior.info), fill=Pooling_type)) +
  geom_line() +
  geom_ribbon( aes(x=pop, ymin=p_lcl, 
                   ymax=p_ucl,
                   color=Pooling_type, group=interaction(Pooling_type,prior.info)), alpha=0.1) +
  theme_classic() +
  facet_wrap(~ve.new.trial)+
  ggtitle('Prob Harmful effect')
```

Evolution of mean estimates for log(VE)..

```{r}
probs %>%
  filter(ve.new.trial==44.4 & Pooling_type != 'Full') %>%
  mutate(Pooling_type = as.factor(Pooling_type)) %>%
ggplot( aes(x=pop, y=parm_mean, group=repN, color=Pooling_type)) +
  geom_line( alpha=0.1) +
  theme_classic() +
  ylim(-4,4)+
  facet_wrap(prior.info~Pooling_type)
```

Evolution of beta1 estimates for a single trial. note the 0.01,0.01 is truncated at smallest trial due to massive uncertainty

```{r}
probs %>%
  filter(ve.new.trial==44.4 & Pooling_type != 'Full' & repN==3) %>%
  mutate(Pooling_type = as.factor(Pooling_type)) %>%
ggplot( aes(x=pop, y=parm_mean, group=interaction(repN,Pooling_type,prior.info), color=Pooling_type)) +
  geom_line( alpha=1) +
  theme_classic() +
   geom_ribbon( aes(x=pop, ymin=lcl, 
                   ymax=ucl,
                   color=Pooling_type, group=Pooling_type), alpha=0.1) +
  facet_wrap(prior.info~Pooling_type) +
  ylim(-4,4) +
  geom_hline(yintercept=0, lty=2)

probs %>%
  filter(ve.new.trial==44.4 & Pooling_type != 'Full' & repN==2) %>%
  mutate(Pooling_type = as.factor(Pooling_type)) %>%
ggplot( aes(x=pop, y=parm_mean, group=interaction(repN,Pooling_type,prior.info), color=interaction(repN,Pooling_type,prior.info))) +
  geom_line( alpha=0.5) +
  theme_classic() +
    #ylim(-4,4) +

  # geom_ribbon( aes(x=pop, ymin=lcl, 
          #         ymax=ucl,
          #         color=Pooling_type, group=interaction(repN,Pooling_type,prior.info)), alpha=0.1) +
  geom_hline(yintercept=0, lty=2)



```

Same, with no real effect

```{r}
probs %>%
  filter(ve.new.trial==0 & Pooling_type != 'Full' & repN==3) %>%
  mutate(Pooling_type = as.factor(Pooling_type)) %>%
ggplot( aes(x=pop, y=parm_mean, group=interaction(repN,Pooling_type,prior.info), color=Pooling_type)) +
  geom_line( alpha=1) +
  theme_classic() +
   geom_ribbon( aes(x=pop, ymin=lcl, 
                   ymax=ucl,
                   color=Pooling_type, group=Pooling_type), alpha=0.1) +
  facet_wrap(prior.info~Pooling_type) +
  ylim(-4,4) +
  geom_hline(yintercept=0, lty=2)

probs %>%
  filter(ve.new.trial==0 & Pooling_type != 'Full' & repN==2) %>%
  mutate(Pooling_type = as.factor(Pooling_type)) %>%
ggplot( aes(x=pop, y=parm_mean, group=interaction(repN,Pooling_type,prior.info), color=interaction(repN,Pooling_type,prior.info))) +
  geom_line( alpha=0.5) +
  theme_classic() +
    #ylim(-4,4) +

  # geom_ribbon( aes(x=pop, ymin=lcl, 
          #         ymax=ucl,
          #         color=Pooling_type, group=interaction(repN,Pooling_type,prior.info)), alpha=0.1) +
  geom_hline(yintercept=0, lty=2)



```

or if there is no real effect

```{r}
probs %>%
  filter(ve.new.trial==0 & Pooling_type != 'Full' & repN==3) %>%
  mutate(Pooling_type = as.factor(Pooling_type)) %>%
ggplot( aes(x=pop, y=parm_mean, group=interaction(repN,Pooling_type,prior.info), color=Pooling_type)) +
  geom_line( alpha=1) +
  theme_classic() +
   geom_ribbon( aes(x=pop, ymin=lcl, 
                   ymax=ucl,
                   color=Pooling_type, group=Pooling_type), alpha=0.1) +
  facet_wrap(prior.info~Pooling_type) +
  ylim(-4,4) +
  geom_hline(yintercept=0, lty=2)

probs %>%
  filter(ve.new.trial==0 & Pooling_type != 'Full' & repN==2) %>%
  mutate(Pooling_type = as.factor(Pooling_type)) %>%
ggplot( aes(x=pop, y=parm_mean, group=interaction(repN,Pooling_type,prior.info), color=interaction(repN,Pooling_type,prior.info))) +
  geom_line( alpha=0.5) +
  theme_classic() +
    ylim(-4,4) +

    geom_hline(yintercept=0, lty=2)
```

```{r}
probs %>%
  filter(ve.new.trial==0 & Pooling_type != 'Full' & repN==1) %>%
  mutate(Pooling_type = as.factor(Pooling_type)) %>%
ggplot( aes(x=pop, y=parm_mean, group=interaction(repN,Pooling_type,prior.info), color=Pooling_type)) +
  geom_line( alpha=0.5) +
  theme_classic() +
   geom_ribbon( aes(x=pop, ymin=lcl, 
                   ymax=ucl,
                   color=Pooling_type, group=interaction(Pooling_type,prior.info)), alpha=0.1) +
  geom_hline(yintercept=0, lty=2)
```

## What proportion of the trials have a probability of any effect? (kind of like power)

```{r, fig.width=7, fig.height=3}
p1 <-probs %>%
  filter(Pooling_type != 'Full') %>%
  mutate(Pooling_type = as.factor(Pooling_type), ve.new.trial=as.factor(ve.new.trial)) %>%
  group_by(pop, ve.new.trial,Pooling_type,prior.info) %>%
  summarize( proportion_any_benefit= mean(p_0>0.975 )) %>%
ggplot( aes(x=pop, y=proportion_any_benefit,  color=interaction(Pooling_type,prior.info), group=interaction(Pooling_type,prior.info))) +
  geom_line() +
  theme_classic() +
  facet_wrap(~ve.new.trial)+
  geom_hline(yintercept=0.8, lty=2, col='gray') +
    geom_hline(yintercept=0.05, lty=2, col='gray') +

  ggtitle('Proportion of trials showing probability of benefit >97.5%')

p1

plotly::ggplotly(p1)
```


same for larger effects

```{r, fig.width=}
probs %>%
  filter(Pooling_type != 'Full') %>%
  mutate(Pooling_type = as.factor(Pooling_type), ve.new.trial=as.factor(ve.new.trial)) %>%
  group_by(pop, ve.new.trial,Pooling_type,prior.info) %>%
  summarize( p_nontrivial_benefit= mean(p_0_95>0.975)) %>%
ggplot( aes(x=pop, y=p_nontrivial_benefit,  color=interaction(Pooling_type,prior.info), group=interaction(Pooling_type,prior.info))) +
  geom_line() +
  theme_classic() +
  facet_wrap(~ve.new.trial)+
  geom_hline(yintercept=c(0.05,0.8), lty=2, col='gray') +
  ggtitle('Proportion of trials showing >97.5% probability of non-trivial benefit (VE>5%)')
```

same for small or no effect (excludes P(harm))

```{r, fig.width=}
probs %>%
  filter(Pooling_type != 'Full') %>%
  mutate(Pooling_type = as.factor(Pooling_type), ve.new.trial=as.factor(ve.new.trial)) %>%
  group_by(pop, ve.new.trial,Pooling_type,prior.info) %>%
  summarize( p_no_benefit= mean(p_similar_0_8__1_25>0.5)) %>%
ggplot( aes(x=pop, y=p_no_benefit,  color=interaction(Pooling_type,prior.info), group=interaction(Pooling_type,prior.info))) +
  geom_line() +
  theme_classic() +
  facet_wrap(~ve.new.trial)+
  geom_hline(yintercept=0.8, lty=2, col='gray') +
  ggtitle('Proportion of trials showing >50% probability of no or small benefit')
```

```{r}
probs %>%
  filter(Pooling_type != 'Full' & pop==1000) %>%
  mutate(Pooling_type = as.factor(Pooling_type), ve.new.trial=as.factor(ve.new.trial)) %>%
  ggplot(aes(x=p_similar_0_8__1_25, y=p_0)) +
  geom_point() +
  theme_classic()
```

## Traditional frequentist measures of power, type 1 error

Is the UCL \<0?

```{r}

powers <- all.mods %>%
  filter(parm=='beta1' & Pooling_type!='Full') %>%
  group_by(ve.new.trial,Pooling_type,pop,prior.info) %>%
  summarize( power=mean(ucl <0)*100 )

ggplot(powers, aes(x=pop, y=power, group=interaction(Pooling_type,prior.info), color=interaction(Pooling_type,prior.info))) +
  geom_line()+
  theme_classic()+
    facet_wrap(~ve.new.trial)+
  geom_hline(yintercept=c(5,80), lty=2, col='gray') +
  xlab("N vaccine group")+
  ggtitle('Frequentist power')
  
  
```

```{r}

prop_pop_90 <- all.mods %>%
  filter(parm=='beta1' & Pooling_type!='Full') %>%
  group_by(ve.new.trial,Pooling_type,pop) %>%
  summarize( prop_any_effect=mean(p_0 >=0.9)*100 )

ggplot(prop_pop_90, aes(x=pop, y=prop_any_effect, group=Pooling_type, color=Pooling_type)) +
  geom_line()+
  theme_classic()+
    facet_wrap(~ve.new.trial)+
  #geom_hline(yintercept=c(5,80), lty=2, col='gray') +
  xlab("N vaccine group")+
  ggtitle('Proportion of trials with 90% posterior probability of any effect')
  
  
```

```{r}

prop_pop_90 <- all.mods %>%
  filter(parm=='beta1' & Pooling_type!='Full') %>%
  group_by(ve.new.trial,Pooling_type,pop) %>%
  summarize( prop_no_effect=mean(p_similar_0_8__1_25 >=0.75)*100 )

ggplot(prop_pop_90, aes(x=pop, y=prop_no_effect, group=Pooling_type, color=Pooling_type)) +
  geom_line()+
  theme_classic()+
    facet_wrap(~ve.new.trial)+
  #geom_hline(yintercept=c(5,80), lty=2, col='gray') +
  xlab("N vaccine group")+
  ggtitle('Proportion of trials with 75% posterior probability of NO effect')
  
  
```

How do the three models perform when there is NO real effect?

1: no pooling 2: highly informative prior (full use) 3:Gamma, (4:Half-Cauchy 5: mixture model)

```{r, fig.width=8, fig.height=3}

 all.mods %>%   filter(ve.new.trial==0 & Pooling_type=='none' & pop==300) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==0 & Pooling_type=='Full' & pop==300) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==0 & Pooling_type=='Commensurate' & pop==300) %>%   caterplot.func()

ggplot()


```

For a larger dataset

```{r, fig.width=6, fig.height=3}
 all.mods %>%   filter(ve.new.trial==0 & Pooling_type=='none' & pop==1000) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==0 & Pooling_type=='Full' & pop==1000) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==0 & Pooling_type=='Commensurate' & pop==1000) %>%   caterplot.func()


```

```{r, fig.width=6, fig.height=3}
 all.mods %>%   filter(ve.new.trial==0 & Pooling_type=='none' & pop==1500) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==0 & Pooling_type=='Full' & pop==1500) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==0 & Pooling_type=='Commensurate' & pop==1500) %>%   caterplot.func()


```

How do the three models perform when there is a real effect, consistent with the original?

```{r, fig.width=6, fig.height=3}
 all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='none' & pop==300) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='Full' & pop==300) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='Commensurate' & pop==300) %>%   caterplot.func()
```

```{r, fig.width=6, fig.height=3}
 all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='none' & pop==500) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='Full' & pop==500) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='Commensurate' & pop==500) %>%   caterplot.func()


```

```{r, fig.width=6, fig.height=3}
 all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='none' & pop==900) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='Full' & pop==900) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='Commensurate' & pop==900) %>%   caterplot.func()


```

```{r, fig.width=6, fig.height=3}
 all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='none' & pop==1000) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='Full' & pop==1000) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='Commensurate' & pop==1000) %>%   caterplot.func()


```

```{r, fig.width=6, fig.height=3}
 all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='none' & pop==1500) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='Full' & pop==1500) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==44.4 & Pooling_type=='Commensurate' & pop==1500) %>%   caterplot.func()


```

## What if there is a discrepant effect between prior and new trial

```{r, fig.width=6, fig.height=3}
 all.mods %>%   filter(ve.new.trial==90 & Pooling_type=='none' & pop==300) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==90 & Pooling_type=='Full' & pop==300) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==90 & Pooling_type=='Commensurate' & pop==300) %>%   caterplot.func()


 all.mods %>%   filter(ve.new.trial==90 & Pooling_type=='none' & pop==1000) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==90 & Pooling_type=='Full' & pop==1000) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==90 & Pooling_type=='Commensurate' & pop==1000) %>%   caterplot.func()

  all.mods %>%   filter(ve.new.trial==90 & Pooling_type=='none' & pop==1500) %>%   caterplot.func() +
 all.mods %>%   filter(ve.new.trial==90 & Pooling_type=='Full' & pop==1500) %>%   caterplot.func() +
   all.mods %>%   filter(ve.new.trial==90 & Pooling_type=='Commensurate' & pop==1500) %>%   caterplot.func()

```
